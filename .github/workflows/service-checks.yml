name: Service Checks

on:
  pull_request:
    paths:
      - .github/workflows/service-checks.yml
      - .pre-commit-config.yaml
      - pyproject.toml
      - services/context-retriever/**
      - services/web-app/**
      - services/llm-proxy/**
      - .devcontainer/**
  push:
    paths:
      - .github/workflows/service-checks.yml
      - .pre-commit-config.yaml
      - pyproject.toml
      - services/context-retriever/**
      - services/web-app/**
      - services/llm-proxy/**
      - .devcontainer/**

permissions:
  contents: read

env:
  PRECOMMIT_CMD: just run-precommit
  SSH_AUTH_SOCK: /tmp/ssh-agent

jobs:
  changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      context-retriever: ${{ steps.filter.outputs.context-retriever }}
      web-app: ${{ steps.filter.outputs.web-app }}
      llm-proxy: ${{ steps.filter.outputs.llm-proxy }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine impacted services
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            context-retriever:
              - services/context-retriever/**
              - .pre-commit-config.yaml
              - pyproject.toml
              - .github/workflows/service-checks.yml
              - .devcontainer/context-retriever/**
              - .devcontainer/scripts/**
            web-app:
              - services/web-app/**
              - .pre-commit-config.yaml
              - pyproject.toml
              - .github/workflows/service-checks.yml
              - .devcontainer/web-app/**
              - .devcontainer/scripts/**
            llm-proxy:
              - services/llm-proxy/**
              - .pre-commit-config.yaml
              - pyproject.toml
              - .github/workflows/service-checks.yml
              - .devcontainer/llm-proxy/**
              - .devcontainer/scripts/**

  precommit-context-retriever:
    name: Pre-commit (context-retriever)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.context-retriever == 'true'
    env:
      DEVCONTAINER_CONFIG: .devcontainer/context-retriever/devcontainer.json
      SERVICE_WORKDIR: /home/appuser/workspace/services/context-retriever
    steps: &precommit_steps
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Verify Docker engine
        run: docker version
      - name: Ensure SSH agent mount path exists
        run: |
          if [ ! -e "${SSH_AUTH_SOCK}" ]; then
            touch "${SSH_AUTH_SOCK}"
          fi
      - name: Run pre-commit in devcontainer
        uses: devcontainers/ci@v0.3
        with:
          configFile: ${{ env.DEVCONTAINER_CONFIG }}
          runCmd: bash -lc "cd ${{ env.SERVICE_WORKDIR }} && ${{ env.PRECOMMIT_CMD }}"

  precommit-web-app:
    name: Pre-commit (web-app)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web-app == 'true'
    env:
      DEVCONTAINER_CONFIG: .devcontainer/web-app/devcontainer.json
      SERVICE_WORKDIR: /home/appuser/workspace/services/web-app
    steps: *precommit_steps

  precommit-llm-proxy:
    name: Pre-commit (llm-proxy)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.llm-proxy == 'true'
    env:
      DEVCONTAINER_CONFIG: .devcontainer/llm-proxy/devcontainer.json
      SERVICE_WORKDIR: /home/appuser/workspace/services/llm-proxy
    steps: *precommit_steps
