name: Service checks

on:
  pull_request:
    paths:
      - "services/**"
      - ".pre-commit-config.yaml"
      - "pyproject.toml"
      - ".github/workflows/service-checks.yml"
  push:
    branches: [main, develop, gh-actions]
    paths:
      - "services/**"
      - ".pre-commit-config.yaml"
      - "pyproject.toml"
      - ".github/workflows/service-checks.yml"

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      context_retriever: ${{ steps.filter.outputs.context_retriever }}
      llm_proxy: ${{ steps.filter.outputs.llm_proxy }}
      web_app: ${{ steps.filter.outputs.web_app }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            context_retriever:
              - "services/context-retriever/**"
              - ".pre-commit-config.yaml"
              - "pyproject.toml"
            llm_proxy:
              - "services/llm-proxy/**"
              - ".pre-commit-config.yaml"
              - "pyproject.toml"
            web_app:
              - "services/web-app/**"
              - ".pre-commit-config.yaml"
              - "pyproject.toml"

  precommit-context-retriever:
    needs: changes
    if: needs.changes.outputs.context_retriever == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run just run-precommit (devcontainer)
        uses: devcontainers/ci@v0.3
        with:
          subFolder: services/context-retriever
          runCmd: just run-precommit

  precommit-llm-proxy:
    needs: changes
    if: needs.changes.outputs.llm_proxy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run just run-precommit (devcontainer)
        uses: devcontainers/ci@v0.3
        with:
          subFolder: services/llm-proxy
          runCmd: just run-precommit

  precommit-web-app:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web_app == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Run just run-precommit (devcontainer)
        uses: devcontainers/ci@v0.3
        with:
          subFolder: services/web-app
          configFile: .devcontainer/web-app/devcontainer.json
          runCmd: just run-precommit

